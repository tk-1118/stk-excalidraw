<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络图片粘贴测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-urls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .url-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 12px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .url-item:hover {
            background: #e9ecef;
        }
        .instructions {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .instructions h2 {
            margin-top: 0;
            color: #0066cc;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #excalidraw-container {
            height: 600px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>网络图片粘贴功能测试</h1>
        
        <div class="instructions">
            <h2>测试说明</h2>
            <p>本页面用于测试修复后的网络图片粘贴功能，包括以下三个问题的修复：</p>
            <ol>
                <li><strong>加载特效</strong>：粘贴图片网络路径时，加载过程中应显示旋转的加载动画</li>
                <li><strong>图片尺寸</strong>：网络图片应自动调整到合适的显示尺寸，无需手动拉伸</li>
                <li><strong>缓存清理</strong>：粘贴非图片内容后，不应显示之前的网络图片</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>测试步骤 1：网络图片粘贴</h3>
            <p>点击下面的图片URL复制到剪贴板，然后在画布中粘贴（Ctrl+V 或 Cmd+V）</p>
            <div class="test-urls">
                <div class="url-item" onclick="copyToClipboard('https://picsum.photos/800/600?random=1')">
                    https://picsum.photos/800/600?random=1
                </div>
                <div class="url-item" onclick="copyToClipboard('https://picsum.photos/400/300?random=2')">
                    https://picsum.photos/400/300?random=2
                </div>
                <div class="url-item" onclick="copyToClipboard('https://picsum.photos/1200/800?random=3')">
                    https://picsum.photos/1200/800?random=3
                </div>
                <div class="url-item" onclick="copyToClipboard('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=500&h=300')">
                    Unsplash 示例图片
                </div>
                <div class="url-item" onclick="copyToClipboard('https://httpbin.org/delay/3?url=https://picsum.photos/600/400?random=999')">
                    测试加载动画 (3秒延迟)
                </div>
                <div class="url-item" onclick="copyToClipboard('https://httpbin.org/status/404')">
                    测试404错误 (无效图片地址)
                </div>
                <div class="url-item" onclick="copyToClipboard('https://nonexistent-domain-12345.com/image.jpg')">
                    测试域名不存在错误
                </div>
                <div class="url-item" onclick="copyToClipboard('invalid-url-format')">
                    测试无效URL格式
                </div>
            </div>
            <p><strong>预期结果</strong>：</p>
            <ul>
                <li><strong>正常图片</strong>：粘贴后立即显示<strong>明显的加载动画</strong>，包含：</li>
                <ul>
                    <li>蓝色渐变背景</li>
                    <li>动态闪烁的蓝色边框</li>
                    <li>旋转的蓝色圆点动画（12个圆点，更流畅）</li>
                    <li>中心脉冲圆圈效果</li>
                    <li>沙漏图标（⏳）</li>
                    <li>"加载中..."文本提示</li>
                </ul>
                <li>图片加载完成后自动显示为合适的尺寸</li>
                <li>无需手动拖拽调整即可看到完整图片</li>
                <li><strong>错误图片</strong>：应该显示错误占位符，包含：</li>
                <ul>
                    <li>错误图标（红色感叹号）</li>
                    <li>具体的错误信息（如"图片不存在"、"域名无法解析"、"无效URL格式"等）</li>
                    <li>错误类型标识（如"NETWORK_ERROR"、"INVALID_RESPONSE"等）</li>
                </ul>
            </ul>
        </div>

        <div class="test-section">
            <h3>测试步骤 2：文本粘贴测试</h3>
            <p>在粘贴了网络图片后，复制并粘贴下面的文本内容</p>
            <div class="test-urls">
                <div class="url-item" onclick="copyToClipboard('这是一段测试文本，用于验证缓存清理功能')">
                    测试文本 1
                </div>
                <div class="url-item" onclick="copyToClipboard('Hello World! This is a test message.')">
                    测试文本 2
                </div>
                <div class="url-item" onclick="copyToClipboard('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==')">
                    Base64 图片数据
                </div>
            </div>
            <p><strong>预期结果</strong>：</p>
            <ul>
                <li>粘贴文本后应正常显示文本元素</li>
                <li>不应显示之前粘贴的网络图片</li>
                <li>缓存应被正确清理</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>测试步骤 3：本地图片上传测试</h3>
            <p><strong>重要测试</strong>：验证本地图片先上传再使用网络地址显示</p>
            <ol>
                <li>复制一个本地图片文件（从文件管理器或其他应用）</li>
                <li>使用 Ctrl+V 粘贴到画布</li>
                <li>观察状态提示信息</li>
                <li>或者拖拽一个本地图片文件到画布</li>
                <li>或者点击工具栏的图片按钮选择本地图片</li>
            </ol>
            <p><strong>预期结果</strong>：</p>
            <ul>
                <li>应该显示"正在上传图片..."的状态提示</li>
                <li>上传完成后显示"图片上传成功"的提示</li>
                <li>图片应该使用上传后的网络地址显示</li>
                <li>检查浏览器开发者工具，图片请求应该是网络URL而不是本地文件</li>
                <li><strong>如果上传失败</strong>：应该显示<strong>详细的错误信息</strong>，包含错误类型、原因和解决方案，不会回退到本地文件处理</li>
                <li><strong>如果没有配置上传服务</strong>：应该显示"未配置图片上传服务"的错误</li>
            </ul>
            <div class="test-urls">
                <div class="url-item" onclick="testUploadError('unauthorized')">
                    测试401未授权错误
                </div>
                <div class="url-item" onclick="testUploadError('forbidden')">
                    测试403权限不足错误
                </div>
                <div class="url-item" onclick="testUploadError('server_error')">
                    测试500服务器错误
                </div>
                <div class="url-item" onclick="testUploadError('network_error')">
                    测试网络连接错误
                </div>
                <div class="url-item" onclick="testUploadError('invalid_response')">
                    测试响应格式错误
                </div>
            </div>
            <ul>
            </ul>
            <p><strong>注意</strong>：</p>
            <ul>
                <li>本测试页面默认使用模拟上传配置进行演示</li>
                <li>实际项目中会自动使用ZZ-Infra配置（zzInfraCustomConfig）</li>
                <li>要测试真实的ZZ-Infra上传，请将页面中的 <code>useRealZZInfraConfig</code> 设置为 <code>true</code></li>
                <li>真实配置会上传到：<code>http://49.232.13.110:83/zz-infra/zz-resource/oss/endpoint/put-file-attach</code></li>
            </ul>
        </div>

        <div class="test-section">
            <h3>测试步骤 4：缓存清理测试</h3>
            <p>验证本地图片不会被网络图片缓存干扰</p>
            <ol>
                <li>先粘贴一个网络图片URL（使用上面的测试URL）</li>
                <li>等待网络图片加载完成并显示在画布上</li>
                <li>然后粘贴一个本地图片文件</li>
            </ol>
            <p><strong>预期结果</strong>：</p>
            <ul>
                <li>每个图片元素应该显示其对应的正确图片内容</li>
                <li>网络图片缓存不应该干扰本地图片的显示</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>测试步骤 5：初始数据网络图片测试</h3>
            <p><strong>重要测试</strong>：验证初始化画布时网络图片能够正确加载</p>
            <div class="test-urls">
                <div class="url-item" onclick="loadInitialDataWithNetworkImages()">
                    加载包含网络图片的初始数据
                </div>
                <div class="url-item" onclick="clearCanvas()">
                    清空画布
                </div>
            </div>
            <p><strong>预期结果</strong>：</p>
            <ul>
                <li>点击"加载包含网络图片的初始数据"后，画布应该显示网络图片</li>
                <li>图片应该立即或很快显示出来，不需要手动操作</li>
                <li>检查浏览器控制台，应该看到预加载网络图片的日志</li>
                <li>图片加载完成后应该自动重新渲染</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>测试步骤 6：混合内容测试</h3>
            <p>测试同时包含图片和文本的复制粘贴</p>
            <div class="test-urls">
                <div class="url-item" onclick="copyToClipboard('<p>文本内容</p><img src=&quot;https://picsum.photos/300/200?random=4&quot; alt=&quot;测试图片&quot;>')">
                    HTML 混合内容
                </div>
            </div>
        </div>

        <div id="status"></div>
        
        <div id="excalidraw-container"></div>
    </div>

    <script type="module">
        import { Excalidraw } from "../index.js";
        import { createElement } from "react";
        import { createRoot } from "react-dom/client";

        // 复制到剪贴板的辅助函数
        window.copyToClipboard = async function(text) {
            try {
                await navigator.clipboard.writeText(text);
                showStatus(`已复制到剪贴板: ${text.substring(0, 50)}...`, 'success');
            } catch (err) {
                showStatus('复制失败: ' + err.message, 'error');
            }
        };

        // 显示状态信息
        window.showStatus = function(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        };

        // 测试用的图片上传配置
        // 注意：这里使用模拟配置，实际项目中会自动使用ZZ-Infra配置
        let mockUploadErrorType = null; // 用于测试不同类型的错误
        
        const testImageUploadConfig = {
            uploadUrl: 'https://httpbin.org/post', // 测试用的API
            customUpload: async (file) => {
                // 模拟ZZ-Infra上传过程
                showStatus('正在上传图片到ZZ-Infra服务...', 'success');
                
                // 模拟上传延迟
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // 如果设置了错误类型，模拟对应的错误
                if (mockUploadErrorType) {
                    const errorType = mockUploadErrorType;
                    mockUploadErrorType = null; // 重置错误类型
                    
                    switch (errorType) {
                        case 'unauthorized':
                            throw new Error('上传失败: 401 Unauthorized');
                        case 'forbidden':
                            throw new Error('上传失败: 403 Forbidden');
                        case 'server_error':
                            throw new Error('上传失败: 500 Internal Server Error');
                        case 'network_error':
                            throw new Error('Network error: Failed to fetch');
                        case 'invalid_response':
                            throw new Error('服务器返回的数据中缺少图片链接');
                        default:
                            break;
                    }
                }
                
                // 返回一个模拟的网络地址（模拟ZZ-Infra返回格式）
                const mockUrl = `https://picsum.photos/400/300?random=${Date.now()}`;
                showStatus(`ZZ-Infra上传成功: ${mockUrl}`, 'success');
                return mockUrl;
            }
        };

        // 如果要测试真实的ZZ-Infra配置，可以设置为null让系统自动使用
        const useRealZZInfraConfig = false; // 设置为true使用真实配置

        // 全局变量存储Excalidraw API
        let excalidrawAPI = null;

        // 测试用的初始数据，包含网络图片
        const initialDataWithNetworkImages = {
            elements: [
                {
                    id: "test-network-image-1",
                    type: "image",
                    x: 100,
                    y: 100,
                    width: 300,
                    height: 200,
                    strokeColor: "transparent",
                    backgroundColor: "transparent",
                    fillStyle: "solid",
                    strokeWidth: 1,
                    strokeStyle: "solid",
                    roughness: 1,
                    opacity: 100,
                    imageUrl: "https://picsum.photos/400/300?random=100",
                    status: "saved",
                    locked: false,
                    link: null,
                    updated: Date.now(),
                    seed: Math.floor(Math.random() * 1000000),
                    versionNonce: Math.floor(Math.random() * 1000000),
                    isDeleted: false,
                    groupIds: [],
                    frameId: null,
                    roundness: null,
                    boundElements: null,
                    customData: null,
                    index: "a0"
                },
                {
                    id: "test-network-image-2", 
                    type: "image",
                    x: 450,
                    y: 100,
                    width: 250,
                    height: 180,
                    strokeColor: "transparent",
                    backgroundColor: "transparent",
                    fillStyle: "solid",
                    strokeWidth: 1,
                    strokeStyle: "solid",
                    roughness: 1,
                    opacity: 100,
                    imageUrl: "https://picsum.photos/350/250?random=200",
                    status: "saved",
                    locked: false,
                    link: null,
                    updated: Date.now(),
                    seed: Math.floor(Math.random() * 1000000),
                    versionNonce: Math.floor(Math.random() * 1000000),
                    isDeleted: false,
                    groupIds: [],
                    frameId: null,
                    roundness: null,
                    boundElements: null,
                    customData: null,
                    index: "a1"
                }
            ],
            appState: {
                viewBackgroundColor: "#ffffff"
            }
        };

        // 加载包含网络图片的初始数据
        window.loadInitialDataWithNetworkImages = function() {
            if (excalidrawAPI) {
                showStatus('加载包含网络图片的初始数据...', 'success');
                excalidrawAPI.updateScene(initialDataWithNetworkImages);
                showStatus('初始数据已加载，请查看控制台日志', 'success');
            } else {
                showStatus('Excalidraw API 未准备就绪', 'error');
            }
        };

        // 清空画布
        window.clearCanvas = function() {
            if (excalidrawAPI) {
                excalidrawAPI.updateScene({
                    elements: [],
                    appState: {
                        viewBackgroundColor: "#ffffff"
                    }
                });
                showStatus('画布已清空', 'success');
            } else {
                showStatus('Excalidraw API 未准备就绪', 'error');
            }
        };

        // 测试不同类型的上传错误
        window.testUploadError = function(errorType) {
            mockUploadErrorType = errorType;
            const errorDescriptions = {
                'unauthorized': '401未授权错误 - 模拟token无效或缺失',
                'forbidden': '403权限不足错误 - 模拟账户权限不够',
                'server_error': '500服务器错误 - 模拟服务器内部故障',
                'network_error': '网络连接错误 - 模拟网络不可达',
                'invalid_response': '响应格式错误 - 模拟服务器返回格式异常'
            };
            showStatus(`已设置模拟错误: ${errorDescriptions[errorType]}，请选择一个图片文件进行测试`, 'info');
            document.getElementById('fileInput').click();
        };

        // 初始化 Excalidraw
        const container = document.getElementById('excalidraw-container');
        const root = createRoot(container);
        
        root.render(
            createElement(Excalidraw, {
                initialData: {
                    elements: [],
                    appState: {
                        viewBackgroundColor: "#ffffff",
                        currentItemStrokeColor: "#000000",
                        currentItemBackgroundColor: "transparent",
                    }
                },
                // 图片上传配置：如果useRealZZInfraConfig为true则不传配置（让系统自动使用ZZ-Infra），否则使用测试配置
                imageUploadConfig: useRealZZInfraConfig ? undefined : testImageUploadConfig,
                onPaste: (data, event) => {
                    console.log('粘贴事件:', data);
                    if (data.mixedContent) {
                        const hasImages = data.mixedContent.some(item => item.type === 'imageUrl');
                        const hasText = data.mixedContent.some(item => item.type === 'text');
                        
                        if (hasImages && hasText) {
                            showStatus('检测到混合内容（图片+文本）', 'success');
                        } else if (hasImages) {
                            showStatus('检测到图片URL，开始加载...', 'success');
                        } else if (hasText) {
                            showStatus('检测到文本内容', 'success');
                        }
                    } else if (data.text) {
                        showStatus('粘贴文本: ' + data.text.substring(0, 30) + '...', 'success');
                    }
                    
                    // 返回 undefined 让 Excalidraw 继续处理
                    return undefined;
                },
                ref: (api) => {
                    excalidrawAPI = api;
                    if (api) {
                        console.log('Excalidraw API 已准备就绪');
                    }
                }
            })
        );

        console.log('网络图片粘贴测试页面已加载');
        showStatus('测试页面已准备就绪，请按照说明进行测试', 'success');
    </script>
</body>
</html>
